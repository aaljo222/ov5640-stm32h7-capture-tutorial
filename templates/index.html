<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OV5640 Camera Viewer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>üé• OV5640 Camera Viewer</h1>
            <p>STM32H753 + USB CDC Live Stream</p>
        </header>

        <div class="controls">
            <button id="startBtn" class="btn btn-start" onclick="startCamera()">
                ‚ñ∂ Start Camera
            </button>
            <button id="stopBtn" class="btn btn-stop" onclick="stopCamera()" disabled>
                ‚èπ Stop Camera
            </button>
            <div class="status">
                <span id="statusText">Disconnected</span>
                <span id="fpsText">FPS: 0</span>
            </div>
        </div>

        <div class="video-container">
            <img id="videoStream" src="" alt="Camera feed will appear here">
            <div class="no-signal" id="noSignal">
                <div class="signal-icon">üì∑</div>
                <p>Press START to begin streaming</p>
            </div>
        </div>

        <div class="info">
            <h3>üìã Information</h3>
            <ul>
                <li><strong>Resolution:</strong> 320x240 (QVGA)</li>
                <li><strong>Format:</strong> RGB565</li>
                <li><strong>Interface:</strong> USB CDC</li>
                <li><strong>MCU:</strong> STM32H753ZI</li>
            </ul>
        </div>
    </div>

    <script>
        let isStreaming = false;
        let statusInterval = null;

        function startCamera() {
            fetch('/start')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        isStreaming = true;
                        document.getElementById('startBtn').disabled = true;
                        document.getElementById('stopBtn').disabled = false;
                        document.getElementById('statusText').textContent = 'Connected';
                        document.getElementById('statusText').className = 'status-connected';
                        document.getElementById('noSignal').style.display = 'none';
                        document.getElementById('videoStream').src = '/video_feed?' + new Date().getTime();
                        
                        // FPS ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÏûë
                        startStatusUpdate();
                        
                        showNotification('Camera started successfully', 'success');
                    } else {
                        showNotification('Failed to start camera: ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    showNotification('Error: ' + error, 'error');
                });
        }

        function stopCamera() {
            fetch('/stop')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        isStreaming = false;
                        document.getElementById('startBtn').disabled = false;
                        document.getElementById('stopBtn').disabled = true;
                        document.getElementById('statusText').textContent = 'Disconnected';
                        document.getElementById('statusText').className = 'status-disconnected';
                        document.getElementById('noSignal').style.display = 'flex';
                        document.getElementById('videoStream').src = '';
                        document.getElementById('fpsText').textContent = 'FPS: 0';
                        
                        // FPS ÏóÖÎç∞Ïù¥Ìä∏ Ï§ëÏßÄ
                        stopStatusUpdate();
                        
                        showNotification('Camera stopped', 'info');
                    }
                })
                .catch(error => {
                    showNotification('Error: ' + error, 'error');
                });
        }

        function updateStatus() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    if (data.streaming) {
                        document.getElementById('fpsText').textContent = 'FPS: ' + data.fps;
                    }
                })
                .catch(error => {
                    console.error('Status update error:', error);
                });
        }

        function startStatusUpdate() {
            if (statusInterval === null) {
                statusInterval = setInterval(updateStatus, 500);
            }
        }

        function stopStatusUpdate() {
            if (statusInterval !== null) {
                clearInterval(statusInterval);
                statusInterval = null;
            }
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = 'notification notification-' + type;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÏÉÅÌÉú ÌôïÏù∏
        window.addEventListener('load', () => {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    if (data.streaming) {
                        // Ïù¥ÎØ∏ Ïä§Ìä∏Î¶¨Î∞ç Ï§ëÏù¥Î©¥ UI ÏóÖÎç∞Ïù¥Ìä∏
                        document.getElementById('startBtn').disabled = true;
                        document.getElementById('stopBtn').disabled = false;
                        document.getElementById('statusText').textContent = 'Connected';
                        document.getElementById('statusText').className = 'status-connected';
                        document.getElementById('noSignal').style.display = 'none';
                        document.getElementById('videoStream').src = '/video_feed?' + new Date().getTime();
                        isStreaming = true;
                        startStatusUpdate();
                    }
                });
        });

        // ÌéòÏù¥ÏßÄ Ï¢ÖÎ£å Ïãú Ï†ïÎ¶¨
        window.addEventListener('beforeunload', () => {
            if (isStreaming) {
                navigator.sendBeacon('/stop');
            }
        });
    </script>
</body>
</html>